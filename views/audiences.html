<style>
  /* Reuse styles from main css where possible, specific overrides here */
</style>

<div id="audience-view-container">
  <!-- List View -->
  <div id="audience-list-view">
    <div
      style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        gap: 1rem;
      "
    >
      <div style="display: flex; gap: 1rem; align-items: center; flex: 1;">
        <h3 style="white-space: nowrap;">Your Audiences</h3>
        <input
          type="text"
          id="audience-search"
          class="search-input"
          placeholder="Search audiences..."
        />
      </div>

      <button
        id="btn-add-audience"
        style="
          background: var(--accent-color);
          color: white;
          border: none;
          padding: 0.5rem 1rem;
          border-radius: 0.5rem;
          cursor: pointer;
          display: flex;
          align-items: center;
          gap: 0.5rem;
          white-space: nowrap;
        "
      >
        <span class="material-icons-round" style="font-size: 1.2rem">add</span>
        Create Audience
      </button>
    </div>

    <div class="data-table-container">
      <table class="data-table" id="audience-table">
        <thead>
          <tr>
            <th data-sort="name">
              Name <span class="material-icons-round sort-icon">unfold_more</span>
            </th>
            <th data-sort="description">
              Description <span class="material-icons-round sort-icon">unfold_more</span>
            </th>
            <th data-sort="qualifiers">
              Qualifiers <span class="material-icons-round sort-icon">unfold_more</span>
            </th>
            <th style="text-align: right;">Actions</th>
          </tr>
        </thead>
        <tbody id="audience-table-body">
          <!-- Rows injected here -->
        </tbody>
      </table>
    </div>

    <div
      id="empty-state"
      style="
        text-align: center;
        padding: 3rem;
        color: var(--text-secondary);
        display: none;
      "
    >
      <span
        class="material-icons-round"
        style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5"
        >people</span
      >
      <p>No audiences found. Create one to get started.</p>
    </div>
  </div>

  <!-- Editor View (Hidden by default) -->
  <div id="audience-editor-view" style="display: none">
    <div class="card" style="max-width: 800px; margin: 0 auto">
      <h3 id="editor-title" style="margin-bottom: 1.5rem">Create Audience</h3>

      <form id="audience-form">
        <input type="hidden" id="edit-id" />

        <div style="margin-bottom: 1.5rem">
          <label
            style="
              display: block;
              margin-bottom: 0.5rem;
              font-weight: 500;
              font-size: 0.9rem;
            "
            >Audience Name</label
          >
          <input
            type="text"
            id="aud-name"
            required
            placeholder="e.g. VIP Customers"
            style="
              width: 100%;
              padding: 0.75rem;
              border-radius: 0.5rem;
              border: 1px solid var(--border-color);
              background: var(--bg-body);
              color: var(--text-primary);
            "
          />
        </div>

        <div style="margin-bottom: 1.5rem">
          <label
            style="
              display: block;
              margin-bottom: 0.5rem;
              font-weight: 500;
              font-size: 0.9rem;
            "
            >Description</label
          >
          <textarea
            id="aud-desc"
            rows="3"
            placeholder="e.g. Customers who have purchased more than $1000"
            style="
              width: 100%;
              padding: 0.75rem;
              border-radius: 0.5rem;
              border: 1px solid var(--border-color);
              background: var(--bg-body);
              color: var(--text-primary);
              resize: vertical;
            "
          ></textarea>
        </div>

        <div style="margin-bottom: 1.5rem">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 0.5rem;
            "
          >
            <label style="font-weight: 500; font-size: 0.9rem"
              >Qualifiers</label
            >
            <button
              type="button"
              id="btn-add-qualifier"
              style="
                font-size: 0.8rem;
                padding: 4px 8px;
                background: var(--nav-item-active-bg);
                color: var(--nav-item-active-text);
                border: none;
                border-radius: 4px;
                cursor: pointer;
              "
            >
              + Add Qualifier
            </button>
          </div>

          <div
            id="qualifiers-container"
            style="display: flex; flex-direction: column; gap: 1rem"
          >
            <!-- Qualifier rows injected here -->
          </div>
        </div>

        <div
          style="
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
          "
        >
          <button
            type="button"
            id="btn-cancel"
            style="
              background: transparent;
              border: 1px solid var(--border-color);
              color: var(--text-primary);
              padding: 0.5rem 1.5rem;
              border-radius: 0.5rem;
              cursor: pointer;
            "
          >
            Cancel
          </button>
          <button
            type="submit"
            style="
              background: var(--accent-color);
              color: white;
              border: none;
              padding: 0.5rem 1.5rem;
              border-radius: 0.5rem;
              font-weight: 600;
              cursor: pointer;
            "
          >
            Save Audience
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  (function () {
    // --- State ---
    let audiences = JSON.parse(localStorage.getItem("audiences")) || [];
    let state = {
        filter: '',
        sortKey: 'name',
        sortOrder: 'asc' // or 'desc'
    };

    // --- Elements ---
    const listView = document.getElementById("audience-list-view");
    const editorView = document.getElementById("audience-editor-view");
    const tableBody = document.getElementById("audience-table-body");
    const tableContainer = document.querySelector(".data-table-container");
    const emptyState = document.getElementById("empty-state");
    const form = document.getElementById("audience-form");
    const qualifiersContainer = document.getElementById("qualifiers-container");
    const editorTitle = document.getElementById("editor-title");
    const searchInput = document.getElementById("audience-search");
    const headers = document.querySelectorAll("th[data-sort]");

    // --- Templates ---
    function createQualifierRow(data = {}) {
      const id = Date.now() + Math.random().toString(36).substr(2, 9);
      const div = document.createElement("div");
      div.className = "qualifier-row";
      div.style.cssText =
        "background: var(--bg-body); padding: 1rem; border-radius: 0.5rem; border: 1px solid var(--border-color); position: relative;";

      const type = data.type || "email";
      const value = data.value || "";

      div.innerHTML = `
                <button type="button" class="btn-remove-qualifier" style="position: absolute; top: 0.5rem; right: 0.5rem; background: none; border: none; color: #ef4444; cursor: pointer;">
                    <span class="material-icons-round" style="font-size: 1.2rem;">close</span>
                </button>
                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                    <div style="flex: 1;">
                        <label style="display: block; font-size: 0.8rem; margin-bottom: 4px; color: var(--text-secondary);">Type</label>
                        <select class="qualifier-type" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary);">
                            <option value="email" ${type === "email" ? "selected" : ""}>Email Address</option>
                            <option value="domain" ${type === "domain" ? "selected" : ""}>Domain Name</option>
                        </select>
                    </div>
                    <div style="flex: 2;">
                        <label style="display: block; font-size: 0.8rem; margin-bottom: 4px; color: var(--text-secondary);">Value</label>
                        <input type="text" class="qualifier-value" value="${value}" placeholder="e.g. user@example.com" style="width: 100%; padding: 0.5rem; border-radius: 4px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-primary);">
                    </div>
                </div>
            `;

      const typeSelect = div.querySelector(".qualifier-type");
      const valueInput = div.querySelector(".qualifier-value");

      typeSelect.addEventListener("change", () => {
          if (typeSelect.value === "email") {
              valueInput.placeholder = "e.g. user@example.com";
          } else {
              valueInput.placeholder = "e.g. example.com";
          }
      });

      div
        .querySelector(".btn-remove-qualifier")
        .addEventListener("click", () => div.remove());
      return div;
    }

    function createTableRow(aud) {
      const tr = document.createElement("tr");

      const qualCount = aud.qualifiers ? aud.qualifiers.length : 0;
      // Show first 2 qualifiers as preview
      const preview = aud.qualifiers
        ? aud.qualifiers.slice(0, 2).map(q => `${q.value}`).join(", ") + (qualCount > 2 ? `, +${qualCount - 2} more` : "")
        : "";

      tr.innerHTML = `
          <td>
            <div style="display: flex; align-items: center; gap: 0.75rem;">
                <span class="material-icons-round" style="color: var(--accent-color); background: var(--nav-item-active-bg); padding: 4px; border-radius: 6px; font-size: 1.2rem;">people</span>
                <span style="font-weight: 500;">${aud.name}</span>
            </div>
          </td>
          <td style="color: var(--text-secondary); max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${aud.description || "—"}</td>
          <td>
             <div style="display: flex; flex-direction: column; gap: 2px;">
                <span style="font-size: 0.85rem; color: var(--text-primary);">${preview || "—"}</span>
                <span style="font-size: 0.75rem; color: var(--text-secondary);">(${qualCount} Qualifiers)</span>
             </div>
          </td>
          <td>
            <div class="action-btn-group">
                <button class="icon-btn btn-edit" title="Edit">
                    <span class="material-icons-round" style="font-size: 1.2rem;">edit</span>
                </button>
                <button class="icon-btn btn-delete" title="Delete" style="color: #ef4444;">
                    <span class="material-icons-round" style="font-size: 1.2rem;">delete</span>
                </button>
            </div>
          </td>
      `;

      tr.querySelector(".btn-edit").addEventListener("click", () => openEditor(aud));
      tr.querySelector(".btn-delete").addEventListener("click", () => {
        if (confirm("Are you sure you want to delete this audience?")) {
          deleteAudience(aud.id);
        }
      });

      return tr;
    }

    // --- Actions ---
    function renderList() {
      tableBody.innerHTML = "";

      // Filter
      let displayData = audiences.filter(aud => {
          const search = state.filter.toLowerCase();
          return aud.name.toLowerCase().includes(search) ||
                 (aud.description && aud.description.toLowerCase().includes(search));
      });

      // Sort
      displayData.sort((a, b) => {
          let valA, valB;

          switch(state.sortKey) {
              case 'name':
                  valA = a.name.toLowerCase();
                  valB = b.name.toLowerCase();
                  break;
              case 'description':
                  valA = (a.description || '').toLowerCase();
                  valB = (b.description || '').toLowerCase();
                  break;
              case 'qualifiers':
                  valA = a.qualifiers ? a.qualifiers.length : 0;
                  valB = b.qualifiers ? b.qualifiers.length : 0;
                  break;
              default:
                  return 0;
          }

          if (valA < valB) return state.sortOrder === 'asc' ? -1 : 1;
          if (valA > valB) return state.sortOrder === 'asc' ? 1 : -1;
          return 0;
      });

      // Update Headers
      headers.forEach(th => {
          const icon = th.querySelector('.sort-icon');
          th.classList.remove('sorted');
          icon.textContent = 'unfold_more'; // Default

          if (th.dataset.sort === state.sortKey) {
              th.classList.add('sorted');
              icon.textContent = state.sortOrder === 'asc' ? 'arrow_upward' : 'arrow_downward';
          }
      });

      if (displayData.length === 0) {
        if (state.filter) {
            tableContainer.style.display = "block";
            tableBody.innerHTML = `<tr><td colspan="4" style="text-align: center; padding: 2rem; color: var(--text-secondary);">No results found for "${state.filter}"</td></tr>`;
            emptyState.style.display = "none";
        } else {
            tableContainer.style.display = "none";
            emptyState.style.display = "block";
        }
      } else {
        tableContainer.style.display = "block";
        emptyState.style.display = "none";
        displayData.forEach((aud) => {
          tableBody.appendChild(createTableRow(aud));
        });
      }
    }

    function handleSort(key) {
        if (state.sortKey === key) {
            state.sortOrder = state.sortOrder === 'asc' ? 'desc' : 'asc';
        } else {
            state.sortKey = key;
            state.sortOrder = 'asc';
        }
        renderList();
    }

    function openEditor(aud = null) {
      listView.style.display = "none";
      editorView.style.display = "block";

      // Reset form
      qualifiersContainer.innerHTML = "";
      document.getElementById("edit-id").value = "";
      document.getElementById("aud-name").value = "";
      document.getElementById("aud-desc").value = "";

      if (aud) {
        editorTitle.textContent = "Edit Audience";
        document.getElementById("edit-id").value = aud.id;
        document.getElementById("aud-name").value = aud.name;
        document.getElementById("aud-desc").value = aud.description || "";
        (aud.qualifiers || []).forEach((q) => {
          qualifiersContainer.appendChild(createQualifierRow(q));
        });
      } else {
        editorTitle.textContent = "Create Audience";
        // Add one empty row by default
        qualifiersContainer.appendChild(createQualifierRow());
      }
    }

    function closeEditor() {
      editorView.style.display = "none";
      listView.style.display = "block";
    }

    function deleteAudience(id) {
      audiences = audiences.filter((a) => a.id !== id);
      saveData();
      renderList();
    }

    function saveData() {
      localStorage.setItem("audiences", JSON.stringify(audiences));
    }

    // --- Event Listeners ---
    document
      .getElementById("btn-add-audience")
      .addEventListener("click", () => openEditor());

    document.getElementById("btn-add-qualifier").addEventListener("click", () => {
      qualifiersContainer.appendChild(createQualifierRow());
    });

    document
      .getElementById("btn-cancel")
      .addEventListener("click", closeEditor);

    searchInput.addEventListener("input", (e) => {
        state.filter = e.target.value;
        renderList();
    });

    headers.forEach(th => {
        th.addEventListener("click", () => {
            handleSort(th.dataset.sort);
        });
    });

    form.addEventListener("submit", (e) => {
      e.preventDefault();

      const id = document.getElementById("edit-id").value;
      const name = document.getElementById("aud-name").value;
      const description = document.getElementById("aud-desc").value;

      // Collect qualifiers
      const qualRows = qualifiersContainer.querySelectorAll(".qualifier-row");
      const qualifiers = Array.from(qualRows).map((row) => {
        return {
          type: row.querySelector(".qualifier-type").value,
          value: row.querySelector(".qualifier-value").value,
        };
      });

      if (id) {
        // Update
        const index = audiences.findIndex((a) => a.id === id);
        if (index !== -1) {
          audiences[index] = { ...audiences[index], name, description, qualifiers };
        }
      } else {
        // Create
        const newAud = {
          id: Date.now().toString(),
          name,
          description,
          qualifiers,
        };
        audiences.push(newAud);
      }

      saveData();
      renderList();
      closeEditor();
    });

    // Initialize
    renderList();
  })();
</script>
